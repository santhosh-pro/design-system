<div class="flex flex-col bg-white rounded-2xl overflow-hidden"
  [style.height]="enableSearch() ? 'calc(100vh - 200px)' : 'calc(100vh - 136px)'">
  <!-- Search Bar -->
  @if (enableSearch() || headerComponents.length > 0) {
  <div class="flex px-6 py-5 border-b border-neutral-100 justify-between">
    @if (enableSearch()) {
    <app-text-input placeholder="Search..." type="search" [fullWidth]="false"
      (changeValue)="onSearchTextChanged($event)"></app-text-input>
    }
    <div>
      <ng-content></ng-content>
    </div>
  </div>
  }

  <!-- Table Container -->
  <div class="flex-1 overflow-y-auto relative" [ngClass]="{'overflow-x-auto': enableHorizontallyScrollable()}">

    <table #table class="w-full table-auto">
      <!-- Table Header -->
      <thead class="sticky top-0 bg-white z-60">
        @for (level of getHeaderLevels(); track level) {
        <!-- Header Level Row -->
        <tr sortableTable (sortChange)="onSortChanged($event)"
          class="text-overline text-neutral-500 text-nowrap border-b border-gray-200">
          <!-- Checkbox Column Header -->
          @if (enableRowSelection() && level === 0) {
          <th [attr.rowspan]="getHeaderRowSpan()" class="w-12 px-4 py-3 border-b border-gray-200 sticky z-20 bg-white"
            pinned="left" [style.left]="getCheckboxColumnOffset()">
            <app-checkbox [ngModel]="isAllSelected()" (valueChanged)="onSelectAllRows($event)"></app-checkbox>
          </th>
          }
          @for (cell of getHeaderCellsAtLevel(level); track $index; let colIndex = $index) {
          <th [attr.colspan]="cell.colspan" [attr.rowspan]="cell.rowspan" [attr.data-sortable-key]="cell.sortKey"
            class="relative cursor-pointer px-4 py-3 text-caption font-semibold text-primary-600 uppercase tracking-wider border-b border-gray-200 transition-colors duration-200 hover:bg-indigo-50"
            [ngClass]="[
              getThTrClass(cell),
              cell.pinned ? 'sticky z-20 bg-white' : ''
            ]" [attr.pinned]="cell.pinned"
            [style.left]="cell.pinned === 'left' ? getPinnedLeftOffset(cell.node) : ''"
            [style.right]="cell.pinned === 'right' ? getPinnedRightOffset(cell.node) : ''"
            [style.zIndex]="cell.pinned ? getPinnedZIndex(cell.node) : ''">
            <div class="flex items-center gap-2">
              @if (!('children' in cell.node)) {
              <div class="pin-toggle">
                <!-- Pin Toggle Icon -->
                <svg (click)="onPinToggle(cell.node)" fill="currentColor" stroke="currentColor" width="16px"
                  height="16px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg"
                  [ngClass]="cell.pinned ? 'text-primary-600' : 'text-neutral-500'" class="cursor-pointer">
                  <g>
                    <path
                      d="m525.64 448.04-29.535-200.94h29.93v-23.617h-252.08v23.617h29.945l-29.539 200.94h-28.496v23.617h142.31v104.87h23.617v-104.87h142.33v-23.617zm-227.41 0 29.535-200.94h144.47l29.52 200.94z" />
                  </g>
                </svg>
              </div>
              }
              <!-- Column Title -->
              <span>{{ cell.title }}</span>
              <!-- Sorting Icon -->
              <span class="sort-icon"></span>
            </div>
          </th>
          }
        </tr>
        }

        <!-- Filter Row -->
        @if (hasFilterConfig()) {
        <tr class="bg-neutral-50">
          @if (enableRowSelection()) {
          <th class="w-12 px-4 py-3 border-b border-gray-200 sticky z-20 bg-neutral-50" pinned="left"
            [style.left]="getCheckboxColumnOffset()"></th>
          }
          @for (column of allLeafColumns(); track column; let colIndex = $index) {
          <th class="border-b border-gray-200 px-4 py-3" [ngClass]="[
              getThTrClass(column),
              column.pinned ? 'sticky z-20 bg-neutral-50' : ''
            ]" [attr.pinned]="column.pinned"
            [style.left]="column.pinned === 'left' ? getPinnedLeftOffset(column) : ''"
            [style.right]="column.pinned === 'right' ? getPinnedRightOffset(column) : ''"
            [style.zIndex]="column.pinned ? getPinnedZIndex(column) : ''">
            @if (column.filterConfig) {
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 min-w-0">
              @switch (column.filterConfig.type) {
              @case ('text') {
              <div class="flex items-center w-full min-w-[120px]">
                <app-text-input [placeholder]="column.filterConfig.placeholder || 'Filter...'"
                  [formControl]="getFilterControl(column, 'value')" [fullWidth]="true" [isPrefixSelect]="true"
                  (prefixChanged)="onFilterOperationChanged($event, column)"
                  [prefixOptions]="getFilterOperations(column.filterConfig.type)" [defaultPrefixValue]="'contains'"
                  class="flex-1 min-w-[120px]"></app-text-input>
              </div>
              }
              @case ('number') {
              <div class="flex items-center w-full min-w-[120px]">
                <app-text-input type="number" [placeholder]="column.filterConfig.placeholder || 'Filter...'"
                  [formControl]="getFilterControl(column, 'value')"
                  (valueChanged)="onFilterChanged($event, null, null, column)" [fullWidth]="true"
                  [isPrefixSelect]="true" (prefixChanged)="onFilterOperationChanged($event, column)"
                  [defaultPrefixValue]="'equals'" [prefixOptions]="getFilterOperations(column.filterConfig.type)"
                  class="flex-1 min-w-[120px]"></app-text-input>
              </div>
              }
              @case ('date') {
              <div class="flex items-center w-full min-w-[120px]">
                <app-date-input [formControl]="getFilterControl(column, 'value')"
                  (valueChanged)="onFilterChanged($event, null, null, column)" [fullWidth]="true"
                  [showDatePickerIcon]="true"
                  [inputDateFormat]="column.filterConfig.dateFormat === 'dd/MM/yyyy' ? InputDateFormat.ddmmyyyy : InputDateFormat.mmddyyyy"
                  class="flex-1 min-w-[120px]"></app-date-input>
              </div>
              }
              @case ('select') {
              <div class="flex items-center w-full min-w-[120px]">
                <app-multi-select-dropdown [items]="column.filterConfig.options || []" [fullWidth]="true"
                  [placeholder]="column.filterConfig.placeholder || 'Select...'" [display]="'label'" [value]="'value'"
                  identifier="value" [formControl]="getFilterControl(column, 'value')"
                  class="flex-1 min-w-[120px]"></app-multi-select-dropdown>
              </div>
              }
              }
            </div>
            }
          </th>
          }
        </tr>
        }
      </thead>

      <!-- Table Body -->
      <tbody>
        <ng-content select="[body]"></ng-content>
      </tbody>

      <!-- Data Rows -->
      @if (data().length > 0) {
      <tbody>
        @for (item of data(); track $index; let i = $index) {
        <tr (click)="_onRowClicked(item)" class="transition-colors duration-200 hover:bg-indigo-50"
          [ngClass]="[enableClickableRows() ? 'cursor-pointer' : '', isRowSelected(item) ? 'bg-blue-50' : '']">
          <!-- Checkbox Column -->
          @if (enableRowSelection()) {
          <td class="w-12 px-4 py-3 border-b border-gray-200 sticky z-20 bg-white" pinned="left"
            [style.left]="getCheckboxColumnOffset()">
            <app-checkbox [ngModel]="isRowSelected(item)" (valueChanged)="onRowSelectionChange($event, item)"
              [disabled]="!enableRowSelection()"></app-checkbox>
          </td>
          }
          @for (column of allLeafColumns(); track column; let colIndex = $index) {
          <td class="px-4 py-3 border-b border-gray-100 relative text-body2 text-gray-800" [ngClass]="[
              getThTrClass(column),
              column.pinned ? 'sticky z-20 bg-white' : ''
            ]" [attr.pinned]="column.pinned"
            [style.left]="column.pinned === 'left' ? getPinnedLeftOffset(column) : ''"
            [style.right]="column.pinned === 'right' ? getPinnedRightOffset(column) : ''"
            [style.zIndex]="column.pinned ? getPinnedZIndex(column) : ''">
            @switch (column.type) {
            @default {
            <span class="text-body2 text-neutral-700" [ngClass]="column.textConfig?.textColorClass">{{
              getPropertyValue(item, column) }}</span>
            }
            @case ('text') {
            <span class="text-body2 text-neutral-700 text-nowrap" [ngClass]="column.textConfig?.textColorClass">{{
              getPropertyValue(item, column) }}</span>
            }
            @case ('date') {
            <div class="flex items-center gap-3" [ngClass]="getFlexJustify(column)">
              @if (column.dateConfig?.showIcon ?? true) {
              <svg class="h-4 w-4 text-neutral-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
                <path
                  d="M19 19H5V8H19M16 1V3H8V1H6V3H5C3.89 3 3 3.89 3 5V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V5C21 3.89 20.1 3 19 3H18V1M17 12H12V17H17V12Z"
                  fill="currentColor" />
              </svg>
              }
              @let date = getPropertyValue(item, column);
              @if (date && date != 'null') {
              <span class="text-body2 text-nowrap">{{
                date | date: (column.dateConfig?.dateFormat ?? 'MMM d, y, h:mm a')
                }}</span>
              }
            </div>
            }
            @case ('badge') {
            @let badgeProperty = getBadgeProperty(item, column);
            <div class="flex items-center" [ngClass]="getFlexJustify(column)">
              <app-status-badge [backgroundColorClass]="badgeProperty?.backgroundColorClass ?? null"
                [indicatorColor]="badgeProperty?.indicatorColorClass ?? null"
                [borderColorClass]="badgeProperty?.borderColorClass ?? null"
                [textColorClass]="badgeProperty?.textColorClass ?? null" [isUpperCase]="true"
                [status]="badgeProperty?.displayText ?? 'Unknown'"></app-status-badge>
            </div>
            }
            @case ('custom') {
            @if (column.component) {
            <div class="flex items-center">
              <app-dynamic-renderer [component]="column.component" [rowData]="item" [data]="column.customConfig?.data"
                [rowPosition]="$index + 1" [isLastRow]="$last"
                (actionPerformed)="onRowActionPerformed($event)"></app-dynamic-renderer>
            </div>
            }
            }
            @case ('actions') {
            <div class="flex items-center gap-3" [ngClass]="getFlexJustify(column)">
              @if (column.actionsConfig?.iconActions) {
              @for (iconAction of column.actionsConfig?.iconActions; track iconAction) {
              <div (click)="_onActionClicked(iconAction.actionKey, item, $event)"
                class="flex items-center justify-center h-9 w-9 cursor-pointer rounded-full hover:bg-neutral-100">
                <!-- <app-svg-icon class="text-neutral-500" [src]="iconAction.iconPath" [size]="20"></app-svg-icon> -->
              </div>
              }
              }
              @if (column.actionsConfig?.threeDotMenuActions) {
              @let menuActions = getContextMenuActions(column.actionsConfig?.threeDotMenuActions, item);
              @if (menuActions.length > 0) {
              <app-context-menu-button (onActionClicked)="_onActionClicked($event, item, null)"
                [actions]="menuActions"></app-context-menu-button>
              }
              }
              @if (column.actionsConfig?.textMenuActions) {
              @for (textAction of column.actionsConfig?.textMenuActions; track textAction) {
              <!-- <app-text-button-small (click)="_onActionClicked(textAction.actionKey, item, $event)">{{ textAction.label
                }}</app-text-button-small> -->
              }
              }
              @if (column.actionsConfig?.components) {
              <div class="flex items-center">
                @for (component of column.actionsConfig?.components; track $index) {
                <app-dynamic-renderer [component]="component" [rowData]="item" [data]="column.customConfig?.data"
                  [rowPosition]="$index + 1" [isLastRow]="$last"
                  (actionPerformed)="onRowActionPerformed($event)"></app-dynamic-renderer>
                }
              </div>
              }
            </div>
            }
            }
          </td>
          }
        </tr>
        }
      </tbody>
      }
    </table>
  </div>

  <!-- Pagination -->
  <app-pagination [pageSize]="pageSize()" [totalItems]="totalCount()"
    (pageChange)="onPageChange($event)"></app-pagination>
</div>