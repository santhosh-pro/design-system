<div #root class="flex flex-col bg-white rounded-2xl overflow-hidden shadow-md border border-gray-200">
  <!-- Internal scroll container: header + content + pagination stick within component -->
  <div class="overflow-y-auto md:overflow-visible" [style.max-height]="mobileScrollMaxHeight()">
    <!-- Search & Filters (mobile sticky inside component) -->
    <div class="md:hidden sticky top-0 z-10 border-b border-gray-200 bg-white/95 backdrop-blur px-3 py-2 flex items-center gap-2">
      @if (enableSearch()) {
        <ui-search-field class="flex-1" placeholder="Search" type="search" [width]="'full'" (valueChange)="onSearchTextChanged($event)"></ui-search-field>
      }
      <!-- Inline actions (projected) on mobile -->
      <div class="flex items-center gap-2 overflow-x-auto">
        <ng-content></ng-content>
      </div>
      @if (enableFilters() && filtersTemplate()) {
        <div class="flex items-center gap-2">
          <button type="button" class="shrink-0 p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100" (click)="toggleFilters()" aria-label="Open advanced filters">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 6h18M6 12h12m-7 6h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          @if (filtersApplied()) {
            <button type="button" class="inline-flex items-center gap-1 text-[11px] text-primary-700 bg-primary-50 border border-primary-200 px-2 py-1 rounded-full" (click)="onClearFiltersClicked()" aria-label="Clear filters">
              <span class="inline-block w-2 h-2 rounded-full bg-primary-600"></span>
              Clear
              <svg class="w-3.5 h-3.5 ml-0.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          }
        </div>
      }
    </div>

    <!-- States & List -->
    <div class="relative pb-24 md:pb-0">
  @if (hasError()) {
    <div class="p-8 flex items-center justify-center">
      <div class="text-center space-y-3">
        <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto shadow-sm">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="font-semibold text-gray-900">{{ errorMessage() || 'Failed to load data' }}</div>
        <button type="button" class="px-4 py-2 rounded-lg text-white bg-primary-600 hover:bg-primary-700 active:bg-primary-700/90 transition" (click)="onRetryLoad()">Try again</button>
      </div>
    </div>
  } @else if (isLoading() && data().length === 0) {
    <div class="p-10 flex items-center justify-center">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary-600"></div>
    </div>
  } @else if (data().length === 0) {
    <div class="p-8 text-center text-gray-500">No data available</div>
  } @else {
    <!-- Cards list -->
    <div class="divide-y divide-gray-200">
      @for (item of data(); track $index; let i = $index) {
        <div class="p-3 bg-white" (click)="onRowClicked(item)">
          <div class="flex items-start gap-3">
            @if (enableRowSelection()) {
              <input type="checkbox" [formControl]="getItemControl(item)" (click)="$event.stopPropagation()" class="h-5 w-5 self-center accent-primary-600" aria-label="Select" />
            }
            <div class="flex-1 min-w-0">
              <!-- Header line: primary field, optional mobile summary, and actions (right) -->
              <div class="flex items-start gap-2">
                <div class="flex-1 min-w-0">
                  @let primary = getPrimaryColumn();
                  @let summary = getMobileSummaryColumn();
                  @if (primary) {
                    <div class="text-sm font-semibold text-gray-900 truncate">
                      <ui-table-cell-renderer [column]="primary" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last" (actionPerformed)="onActionPerformed($event)"></ui-table-cell-renderer>
                    </div>
                  }
                  @if (summary) {
                    <div class="text-xs text-gray-600 truncate mt-0.5">
                      <ui-table-cell-renderer [column]="summary" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last" (actionPerformed)="onActionPerformed($event)"></ui-table-cell-renderer>
                    </div>
                  }
                </div>
                @let actionCol = getActionColumn();
                @if (actionCol) {
                  <div class="shrink-0 -mr-1">
                    <ui-table-cell-renderer [column]="actionCol" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last" (actionPerformed)="onActionPerformed($event)"></ui-table-cell-renderer>
                  </div>
                }
              </div>

              <!-- Meta grid (only visible when expanded) -->
              @let details = getExpandableDetailColumns();
              @if (expandedRowIndex === i && details.length > 0) {
                <div class="mt-3 grid grid-cols-2 gap-x-4 gap-y-2">
                  @for (col of details; track col.key || $index) {
                    <div class="min-w-0">
                      <div class="text-[11px] uppercase tracking-wide text-gray-500">{{ col.title }}</div>
                      <div class="text-sm text-gray-900 truncate">
                        <ui-table-cell-renderer [column]="col" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last" (actionPerformed)="onActionPerformed($event)"></ui-table-cell-renderer>
                      </div>
                    </div>
                  }
                </div>
              }

              <!-- Expandable -->
              @if (hasDetailsToExpand()) {
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[11px] uppercase tracking-wide text-gray-400">Details</div>
                  <button type="button" class="h-8 w-8 inline-flex items-center justify-center rounded-full text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-100 transition-colors" aria-label="Toggle details" (click)="$event.stopPropagation(); expandedRowIndex = (expandedRowIndex === i ? -1 : i)">
                    <svg class="w-5 h-5 transition-transform duration-200" [class.rotate-180]="expandedRowIndex === i" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
                @if (expandedRowIndex === i) {
                  @if (expandableComponent()) {
                    <div class="mt-3 rounded-xl border border-gray-200 p-3 bg-gray-50">
                      <ui-dynamic-renderer [component]="expandableComponent()" [rowData]="item" (actionPerformed)="onActionPerformed({ actionKey: 'expand', item })"></ui-dynamic-renderer>
                    </div>
                  }
                }
              }
            </div>
          </div>
        </div>
      }
    </div>
  }
    </div>

    <!-- Sticky bottom pagination (mobile only, within component) -->
    @if (enablePagination() || alwaysShowPagination()) {
      <div class="md:hidden sticky bottom-0 z-10 border-t border-gray-200 bg-white/95 backdrop-blur px-3 pt-2 pb-[calc(env(safe-area-inset-bottom)+0.5rem)] shadow-lg">
  <ui-pagination [(pageNumber)]="pageNumber" [isSimple]="false" [(pageSize)]="pageSize" [totalItems]="totalCount()" (pageChange)="onPageChange($event)"></ui-pagination>
      </div>
    }
  </div>

  <!-- Footer: footer component and pagination -->
  <div class="border-t border-gray-200 bg-white px-4 py-3 hidden md:block">
    @if (footerComponent()) {
      <ui-dynamic-renderer [component]="footerComponent()" [data]="data()" (actionPerformed)="footerAction.emit($event)"></ui-dynamic-renderer>
    }
    @if (enablePagination()) {
  <ui-pagination [(pageNumber)]="pageNumber" [(pageSize)]="pageSize" [totalItems]="totalCount()" (pageChange)="onPageChange($event)"></ui-pagination>
    }
  </div>
</div>
