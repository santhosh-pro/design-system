<div class="flex flex-col bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-200"
  [style.height]="containerHeight() ? containerHeight() : (enableSearch() ? 'calc(100vh - 160px)' : 'calc(100vh - 136px)')"><!-- container start -->

  <!-- Search Bar -->
  <div
    class="flex flex-col sm:flex-row px-3 py-2 border-b border-gray-200 bg-white flex-shrink-0 gap-3 sm:gap-4 items-stretch sm:items-end">
    @if (enableSearch()) {
    <div class="flex-1 min-w-0 space-x-2 flex items-center">
      <ui-search-field placeholder="Search..." type="search" [width]="'md'" (valueChange)="onSearchTextChanged($event)"
        iconSrc="edit.svg">
      </ui-search-field>

        <!-- Advanced Filters trigger (uses filtersTemplate input provided by parent like ui-responsive-data-table) -->
      @if (enableFilters() && filtersTemplate()) {
        <div class="flex items-center gap-2 ml-2">
          <button type="button" class="shrink-0 p-2 text-gray-600 hover:text-gray-900 cursor-pointer rounded-md hover:bg-gray-100" (click)="toggleFilters()" aria-label="Open filters">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M3 6h18M6 12h12m-7 6h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          @if (filtersApplied()) {
            <span class="inline-flex items-center gap-1 text-xs text-green-800 bg-green-50 border border-green-200 px-2 py-1 rounded-full">
              <span class="inline-block w-2 h-2 rounded-full bg-green-600"></span>
              Filters
              <button type="button" class="ml-1 text-gray-500 hover:text-gray-900" (click)="onClearFiltersClicked()" aria-label="Clear filters">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </span>
          }
        </div>
      }
    </div>
    }
    <!-- Actions and Filters Controls -->
    <div class="flex flex-col sm:flex-row gap-2 lg:gap-3 items-stretch sm:items-end">
      <!-- Inline actions slot: visible in header -->
      <div class="flex items-end gap-2 ml-auto justify-end flex-wrap max-w-full overflow-x-auto shrink-0">
        <ng-content></ng-content>
      </div>

      <!-- Capture filters content for overlay only (not shown inline) -->
      <ng-template #projectedFiltersTpl>
        <ng-content select="[table-filter]"></ng-content>
      </ng-template>

    
    </div>
  </div>

  <!-- Table Container -->
  <div class="flex-1 overflow-auto relative h-full" [class.overflow-x-auto]="enableHorizontallyScrollable()">
    <div class="h-full flex flex-col">
   <!-- NOTE: Row height is intentionally fixed (h-12 on body rows/cells). The table itself should not be flexed
     to fill the container, otherwise browsers distribute extra height across rows and the visual row height
     varies with the number of records. Hence, no flex-1 on <table>. -->
   <table #table class="w-full border-separate min-w-[1400px]" style="border-spacing: 0; table-layout: auto;">

        <!-- Sticky Table Header -->
        <thead
          class="sticky top-0 z-[80] flex-shrink-0 bg-gradient-to-b from-gray-50 to-gray-100/95 backdrop-blur supports-[backdrop-filter]:bg-gray-100/80 shadow-sm border-b border-gray-200">
          @for (level of getHeaderLevels(); track level) {
          <tr sortableTable (sortChange)="onSortChanged($event)"
            class="text-xs font-semibold text-gray-700 uppercase tracking-wide"
            [class.opacity-50]="getState() === 'initializing'"
            [class.pointer-events-none]="getState() === 'initializing'">

            <!-- Expandable Column Header -->
            @if (expandableComponent() && level === 0) {
            <th [attr.rowspan]="getHeaderRowSpan()"
              class="sticky left-0 z-[100] bg-gray-100 w-12 px-2 py-2.5 text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.1)]">
            </th>
            }

            <!-- Checkbox Column Header -->
            @if (enableRowSelection() && level === 0) {
            <th [attr.rowspan]="getHeaderRowSpan()"
              class="sticky z-[100] bg-gray-100 w-12 px-2 py-2.5 text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.1)]"
              [ngClass]="{ 'left-12': expandableComponent(), 'left-0': !expandableComponent() }">
              @if (getState() !== 'initializing') {
              <input type="checkbox" [formControl]="selectAllControl" [indeterminate]="isSelectAllIndeterminate()"
                (click)="$event.stopPropagation()"
                class="h-4 w-4 accent-primary-600 focus:ring-primary-500 disabled:accent-gray-400 disabled:opacity-60 cursor-pointer"
                aria-label="Select all rows" />
              }
            </th>
            }

            @for (cell of getHeaderCellsAtLevel(level); track $index; let colIndex = $index) {
            <th [attr.colspan]="cell.colspan" [attr.rowspan]="cell.rowspan" [attr.data-sortable-key]="cell.sortKey"
              [attr.aria-sort]="getAriaSort(cell.sortKey)"
              class="relative cursor-pointer px-2 py-2.5 text-xs font-semibold text-gray-700 uppercase tracking-wide hover:bg-gray-200 bg-gray-100 border-r border-gray-200 transition-colors duration-200"
              [ngClass]="getHeaderThClass(cell)" [class.opacity-50]="getState() === 'initializing'"
              [class.pointer-events-none]="getState() === 'initializing'">
              <div class="flex items-center gap-1.5" [ngClass]="getFlexJustifyClass(cell)">
                <span class="whitespace-normal break-words leading-tight">{{ cell.title }}</span>
              </div>
            </th>
            }
          </tr>
          }
        </thead>

        <!-- State-Based Content Rendering -->
        @switch (getState()) {
        @case ('initializing') {
  <tbody class="relative z-0">
          <tr class="h-full">
            <td [attr.colspan]="getTotalColspan()" class="h-full px-6 py-0 align-middle">
              <div class="h-full flex items-center justify-center min-h-[400px]">
                <div class="flex flex-col items-center space-y-6 max-w-md mx-auto">
                  <div class="flex items-center justify-center w-20 h-20 rounded-full bg-primary-100">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                  </div>
                  <div class="text-center space-y-3">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">Loading...</h3>
                    <p class="text-sm md:text-base text-gray-500 leading-relaxed">Fetching your records</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        }

        @case ('loading') {
        @if (data().length > 0) {
        <!-- Show existing data during subsequent loads -->
  <tbody class="relative z-0">
          @for (item of data(); track getItemId(item); let i = $index) {
          <tr (click)="onRowClicked(item)"
            class="transition-all duration-200 hover:bg-blue-50 odd:bg-white even:bg-gray-100/60 border-b border-gray-200 group h-12"
            [class.cursor-pointer]="enableClickableRows()" [class.bg-blue-100]="isRowSelected(item)"
            [class.hover:bg-blue-200]="isRowSelected(item)">

            <!-- Expandable Column -->
            @if (expandableComponent()) {
            <td
              class="sticky left-0 z-[70] bg-white w-12 px-2 py-0 h-12 align-middle text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.05)] group-hover:bg-blue-50 transition-colors duration-200"
              [class.bg-blue-100]="isRowSelected(item)" [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <div (click)="onRowExpandedClicked(i); $event.stopPropagation()"
                class="mx-auto flex items-center justify-center h-[30px] w-[30px] rounded-full bg-gray-50 hover:bg-gray-100 cursor-pointer transition-all duration-500">
                <svg class="h-[16px] w-[16px] text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none">
                  <path d="M7.41 8.58L12 13.17L16.59 8.58L18 10L12 16L6 10L7.41 8.58Z" fill="currentColor" />
                </svg>
              </div>
            </td>
            }

            <!-- Checkbox Column -->
            @if (enableRowSelection()) {
            <td
              class="sticky z-[70] bg-white w-12 px-2 py-0 h-12 align-middle text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.05)] group-hover:bg-blue-50 transition-colors duration-200"
              [ngClass]="{ 'left-12': expandableComponent(), 'left-0': !expandableComponent() }"
              [class.bg-blue-100]="isRowSelected(item)" [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <input type="checkbox" [formControl]="getItemControl(item)" (click)="$event.stopPropagation()"
                class="h-4 w-4 accent-primary-600 focus:ring-primary-500 disabled:accent-gray-400 disabled:opacity-60 cursor-pointer"
                aria-label="Select row" />
            </td>
            }

            <!-- Data Columns -->
            @for (column of allLeafColumns(); track column.key || $index) {
            <td
              class="px-2 py-0 h-12 align-middle relative text-base text-gray-900 border-r border-gray-200 group-hover:bg-blue-50 transition-colors duration-200"
              [ngClass]="getCellClass(column)" [class.bg-blue-100]="isRowSelected(item)"
              [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <!-- Fixed row height wrapper to ensure consistent row height -->
              <div class="h-12 w-full flex items-center truncate">
                <ui-table-cell-renderer [column]="column" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last"
                  (actionPerformed)="onActionPerformed($event)">
                </ui-table-cell-renderer>
              </div>
            </td>
            }
          </tr>

          <!-- Expanded Row -->
          @if (expandableComponent() && i === expandedRowIndex()) {
          <tr class="transition-all duration-700">
            <td [attr.colspan]="getTotalColspan()">
              <div class="mx-4 my-4 p-4 bg-gray-50 rounded-lg">
                <ui-dynamic-renderer [component]="expandableComponent()" [rowData]="item"
                  (actionPerformed)="onActionPerformed({ actionKey: 'expand', item })">
                </ui-dynamic-renderer>
              </div>
            </td>
          </tr>
          }
          }
        </tbody>
        } @else {
  <tbody class="relative z-0">
          <tr class="h-full">
            <td [attr.colspan]="getTotalColspan()" class="h-full px-6 py-0 bg-gray-50 align-middle">
              <div class="h-full flex items-center justify-center min-h-[400px]">
                <div class="flex flex-col items-center space-y-6 max-w-md mx-auto">
                  <div class="flex items-center justify-center w-20 h-20 rounded-full bg-primary-100">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                  </div>
                  <div class="text-center space-y-3">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">Refreshing...</h3>
                    <p class="text-sm md:text-base text-gray-500 leading-relaxed">Updating your records</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        }
        }

        @case ('error') {
  <tbody class="relative z-0">
          <tr class="h-full">
            <td [attr.colspan]="getTotalColspan()" class="h-full px-6 py-0 bg-gray-50 align-middle">
              <div class="h-full flex items-center justify-center">
                <div class="flex flex-col items-center space-y-6 max-w-md mx-auto">
                  <div class="flex items-center justify-center w-20 h-20 rounded-full bg-red-100">
                    <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div class="text-center space-y-3">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">Failed to load data</h3>
                    <p class="text-sm md:text-base text-gray-500 leading-relaxed">{{ getErrorMessage() || 'Something
                      went wrong while loading your data.' }}</p>
                    <div class="pt-2">
                      <button type="button"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200"
                        (click)="onRetryLoad()">
                        Try Again
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        }

        @case ('success') {
        @if (data().length > 0) {
        <!-- Success with Data - Same structure as loading case -->
  <tbody class="relative z-0">
          @for (item of data(); track getItemId(item); let i = $index) {
          <tr (click)="onRowClicked(item)"
            class="transition-all duration-200 hover:bg-blue-50 odd:bg-white even:bg-gray-100/60 border-b border-gray-200 group h-12"
            [class.cursor-pointer]="enableClickableRows()" [class.bg-blue-100]="isRowSelected(item)"
            [class.hover:bg-blue-200]="isRowSelected(item)">

            <!-- Same row structure as above -->
            @if (expandableComponent()) {
            <td
              class="sticky left-0 z-[70] bg-white w-12 px-2 py-0 h-12 align-middle text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.05)] group-hover:bg-blue-50 transition-colors duration-200"
              [class.bg-blue-100]="isRowSelected(item)" [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <div (click)="onRowExpandedClicked(i); $event.stopPropagation()"
                class="mx-auto flex items-center justify-center h-[30px] w-[30px] rounded-full bg-gray-50 hover:bg-gray-100 cursor-pointer transition-all duration-500">
                <svg class="h-[16px] w-[16px] text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none">
                  <path d="M7.41 8.58L12 13.17L16.59 8.58L18 10L12 16L6 10L7.41 8.58Z" fill="currentColor" />
                </svg>
              </div>
            </td>
            }

            @if (enableRowSelection()) {
            <td
              class="sticky z-[70] bg-white w-12 px-2 py-0 h-12 align-middle text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.05)] group-hover:bg-blue-50 transition-colors duration-200"
              [ngClass]="{ 'left-12': expandableComponent(), 'left-0': !expandableComponent() }"
              [class.bg-blue-100]="isRowSelected(item)" [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <input type="checkbox" [formControl]="getItemControl(item)" (click)="$event.stopPropagation()"
                class="h-4 w-4 accent-primary-600 focus:ring-primary-500 disabled:accent-gray-400 disabled:opacity-60 cursor-pointer"
                aria-label="Select row" />
            </td>
            }

            @for (column of allLeafColumns(); track column.key || $index) {
            <td
              class="px-2 py-0 h-12 align-middle relative text-base text-gray-900 border-r border-gray-200 group-hover:bg-blue-50 transition-colors duration-200"
              [ngClass]="getCellClass(column)" [class.bg-blue-100]="isRowSelected(item)"
              [class.group-hover:bg-blue-200]="isRowSelected(item)">
              <!-- Fixed row height wrapper to ensure consistent row height -->
              <div class="h-12 w-full flex items-center truncate">
                <ui-table-cell-renderer [column]="column" [rowData]="item" [rowIndex]="i + 1" [isLastRow]="$last"
                  (actionPerformed)="onActionPerformed($event)">
                </ui-table-cell-renderer>
              </div>
            </td>
            }
          </tr>

          @if (expandableComponent() && i === expandedRowIndex()) {
          <tr class="transition-all duration-700">
            <td [attr.colspan]="getTotalColspan()">
              <div class="mx-4 my-4 p-4 bg-gray-50 rounded-lg">
                <ui-dynamic-renderer [component]="expandableComponent()" [rowData]="item"
                  (actionPerformed)="onActionPerformed({ actionKey: 'expand', item })">
                </ui-dynamic-renderer>
              </div>
            </td>
          </tr>
          }
          }
        </tbody>
        } @else {
        <tbody class="relative z-0 flex-1">
          <tr class="h-full">
            <td [attr.colspan]="getTotalColspan()" class="h-full px-6 py-0 bg-gray-50 align-middle">
              <div class="h-full flex items-center justify-center">
                <div class="flex flex-col items-center space-y-6 max-w-md mx-auto">
                  <div
                    class="flex items-center justify-center w-20 h-20 rounded-full bg-white shadow-lg border border-gray-200">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                      </path>
                    </svg>
                  </div>
                  <div class="text-center space-y-3">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">No data available</h3>
                    <p class="text-sm md:text-base text-gray-500 leading-relaxed">Table is not configured yet</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        }
        }

        @case ('empty') {
        <tbody class="relative z-0 flex-1">
          <tr class="h-full">
            <td [attr.colspan]="getTotalColspan()" class="h-full px-6 py-0 bg-gray-50 align-middle">
              <div class="h-full flex items-center justify-center">
                <div class="flex flex-col items-center space-y-6 max-w-md mx-auto">
                  <div
                    class="flex items-center justify-center w-20 h-20 rounded-full bg-white shadow-lg border border-gray-200">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                      </path>
                    </svg>
                  </div>
                  <div class="text-center space-y-3">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">No data available</h3>
                    <p class="text-sm md:text-base text-gray-500 leading-relaxed">Table is not configured yet</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        }
        }
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="border-t-2 border-gray-300 bg-white px-4 py-2 flex-shrink-0">
    @if (footerComponent()) {
    <ui-dynamic-renderer [component]="footerComponent()" [data]="data()"
      (actionPerformed)="onFooterActionPerformed($event)">
    </ui-dynamic-renderer>
    }

  @if (enablePagination()) {
  <ui-pagination [(pageNumber)]="pageNumber" [(pageSize)]="pageSize" [totalItems]="totalCount()" (pageChange)="onPageChange($event)">
    </ui-pagination>
    }


  </div>
</div>