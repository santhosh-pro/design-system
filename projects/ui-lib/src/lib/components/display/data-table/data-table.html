<!-- data-table.component.html -->
<div class="flex flex-col bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-200"
  [style.height]="enableSearch() ? 'calc(100vh - 200px)' : 'calc(100vh - 136px)'">
  
  <!-- Search Bar -->
  @if (enableSearch() || headerComponents.length > 0) {
    <div class="flex px-6 py-5 border-b border-gray-300 justify-between items-center bg-white flex-shrink-0">
      @if (enableSearch()) {
        <div class="flex-1 max-w-md">
          
          <ui-text-input 
            placeholder="Search..." 
            type="search" 
            [fullWidth]="false"
            (valueChange)="onSearchTextChanged($event)"
            iconSrc="edit.svg"
            class="w-full">
          </ui-text-input>
        </div>
      }
      <div class="flex items-center gap-4">
        <ng-content></ng-content>
      </div>
    </div>
  }

  <!-- Table Container -->
  <div class="flex-1 overflow-auto relative" 
       [class.overflow-x-auto]="enableHorizontallyScrollable()">

    <table #table class="w-full border-collapse min-w-[1400px]" style="border-spacing: 0; table-layout: auto;">
      
      <!-- Table Header -->
      <thead class="sticky top-0 bg-gray-100 z-[100]">
        @for (level of getHeaderLevels(); track level) {
          <!-- Header Level Row -->
          <tr sortableTable (sortChange)="onSortChanged($event)"
            class="text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-100 border-b-2 border-gray-300">
            
            <!-- Checkbox Column Header -->
            @if (enableRowSelection() && level === 0) {
              <th [attr.rowspan]="getHeaderRowSpan()" 
                  class="sticky left-0 z-[120] bg-gray-100 w-12 px-4 py-4 text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.1)]">
                <ui-checkbox 
                  [ngModel]="isAllSelected()" 
                  (valueChanged)="onSelectAllRows($event)">
                </ui-checkbox>
              </th>
            }
            
            @for (cell of getHeaderCellsAtLevel(level); track $index; let colIndex = $index) {
              <th [attr.colspan]="cell.colspan" 
                  [attr.rowspan]="cell.rowspan" 
                  [attr.data-sortable-key]="cell.sortKey"
                  class="relative cursor-pointer px-4 py-4 text-xs font-semibold text-gray-700 uppercase tracking-wider hover:bg-gray-200 bg-gray-100 border-r-2 border-gray-300 transition-colors duration-200"
                  [class]="getHeaderThClass(cell)">
                <div class="flex items-center gap-2" [class]="getFlexJustifyClass(cell)">
                  <span class="whitespace-normal break-words leading-tight">{{ cell.title }}</span>
                 
                </div>
              </th>
            }
            
          </tr>
        }

        <!-- Filter Row -->
        @if (hasFilterConfig()) {
          <tr class="bg-gray-50 sticky z-[90] border-b-2 border-gray-300" [style.top]="getHeaderHeight() + 'px'">
            @if (enableRowSelection()) {
              <th class="sticky left-0 z-[120] bg-gray-50 w-12 px-4 py-3 border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.1)]"></th>
            }
            
            @for (column of allLeafColumns(); track column; let colIndex = $index) {
              <th class="px-4 py-3 border-r-2 border-gray-300 bg-gray-50"
                  [class]="getCellClass(column)">
                @if (column.filterConfig) {
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2 min-w-0">
                    @switch (column.filterConfig.type) {
                      @case ('text') {
                        <div class="flex items-center w-full min-w-[140px]">
                          <ui-text-input 
                            [placeholder]="column.filterConfig.placeholder || 'Filter...'"
                            [formControl]="getFilterControl(column, 'value')" 
                            [fullWidth]="true" 
                            [hasPrefixSelect]="true"
                            (prefixChange)="onFilterOperationChanged($event, column)"
                            [prefixOptions]="getFilterOperations(column.filterConfig.type)" 
                            [defaultPrefixValue]="'contains'"
                            class="flex-1 min-w-[140px]">
                          </ui-text-input>
                        </div>
                      }
                      @case ('number') {
                        <div class="flex items-center w-full min-w-[120px]">
                          <ui-text-input 
                            type="number" 
                            [placeholder]="column.filterConfig.placeholder || 'Filter...'"
                            [formControl]="getFilterControl(column, 'value')"
                            (valueChanged)="onFilterChanged($event, null, null, column)" 
                            [fullWidth]="true"
                            [hasPrefixSelect]="true" 
                            (prefixChange)="onFilterOperationChanged($event, column)"
                            [defaultPrefixValue]="'equals'" 
                            [prefixOptions]="getFilterOperations(column.filterConfig.type)"
                            class="flex-1 min-w-[120px]">
                          </ui-text-input>
                        </div>
                      }
                      @case ('date') {
                        <div class="flex items-center w-full min-w-[140px]">
                          <ui-date-input 
                            [formControl]="getFilterControl(column, 'value')"
                            (valueChanged)="onFilterChanged($event, null, null, column)" 
                            [fullWidth]="true"
                            [showDatePickerIcon]="true"
                            [inputDateFormat]="column.filterConfig.dateFormat === 'dd/MM/yyyy' ? InputDateFormat.ddmmyyyy : InputDateFormat.mmddyyyy"
                            class="flex-1 min-w-[140px]">
                          </ui-date-input>
                        </div>
                      }
                      @case ('select') {
                        <div class="flex items-center w-full min-w-[100px]">
                          <ui-multi-select-dropdown 
                            [items]="column.filterConfig.options || []" 
                            [fullWidth]="true"  
                            [enableSearch]="true" 
                            [placeholder]="column.filterConfig.placeholder || 'Select...'" 
                            [display]="'label'" 
                            [value]="'value'"
                            identifier="value" 
                            [formControl]="getFilterControl(column, 'value')"
                            class="flex-1 min-w-[100px]">
                          </ui-multi-select-dropdown>
                        </div>
                      }
                    }
                  </div>
                } @else if (column.type === 'actions') {
                  <!-- Empty space for actions column in filter row -->
                  <div class="h-10"></div>
                }
              </th>
            }
          </tr>
        }
      </thead>

      <!-- Table Body -->
      <tbody class="relative z-0">
        <ng-content select="[body]"></ng-content>
      </tbody>

      <!-- Data Rows -->
      @if (data().length > 0) {
        <tbody class="relative z-0">
          @for (item of data(); track $index; let i = $index) {
            <tr (click)="onRowClicked(item)" 
                class="transition-all duration-200 hover:bg-blue-50 bg-white border-b border-gray-200 group"
                [class.cursor-pointer]="enableClickableRows()"
                [class.bg-blue-100]="isRowSelected(item)"
                [class.hover:bg-blue-200]="isRowSelected(item)">
              
              <!-- Checkbox Column -->
              @if (enableRowSelection()) {
                <td class="sticky left-0 z-[50] bg-white w-12 px-4 py-4 text-center border-r-2 border-gray-300 shadow-[2px_0_4px_rgba(0,0,0,0.05)] group-hover:bg-blue-50 transition-colors duration-200"
                    [class.bg-blue-100]="isRowSelected(item)"
                    [class.group-hover:bg-blue-200]="isRowSelected(item)">
                  <ui-checkbox 
                    [ngModel]="isRowSelected(item)" 
                    (valueChanged)="onRowSelectionChange($event, item)"
                    [disabled]="!enableRowSelection()">
                  </ui-checkbox>
                </td>
              }
              
              @for (column of allLeafColumns(); track column; let colIndex = $index) {
                <td class="px-4 py-4 relative text-sm text-gray-900 bg-white border-r border-gray-200 group-hover:bg-blue-50 transition-colors duration-200"
                    [class]="getCellClass(column)"
                    [class.bg-blue-100]="isRowSelected(item)"
                    [class.group-hover:bg-blue-200]="isRowSelected(item)">
                  
                  @switch (column.type) {
                    @default {
                      <span class="text-sm text-gray-800 block truncate" 
                            [class]="column.textConfig?.textColorClass || ''"
                            [title]="getPropertyValue(item, column)">
                        {{ getPropertyValue(item, column) }}
                      </span>
                    }
                    
                    @case ('text') {
                      <span class="text-sm text-gray-800 block truncate" 
                            [class]="column.textConfig?.textColorClass || ''"
                            [title]="getPropertyValue(item, column)">
                        {{ getPropertyValue(item, column) }}
                      </span>
                    }
                    
                    @case ('date') {
                      <div class="flex items-center gap-3" [class]="getFlexJustify(column)">
                        @if (column.dateConfig?.showIcon ?? true) {
                          <svg class="h-4 w-4 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
                            <path d="M19 19H5V8H19M16 1V3H8V1H6V3H5C3.89 3 3 3.89 3 5V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V5C21 3.89 20.1 3 19 3H18V1M17 12H12V17H17V12Z" fill="currentColor"/>
                          </svg>
                        }
                        @let date = getPropertyValue(item, column);
                        @if (date && date != 'null') {
                          <span class="text-sm whitespace-nowrap">
                            {{ date | date: (column.dateConfig?.dateFormat ?? 'MMM d, y, h:mm a') }}
                          </span>
                        }
                      </div>
                    }
                    
                    @case ('badge') {
                      @let badgeProperty = getBadgeProperty(item, column);
                      <div class="flex items-center" [class]="getFlexJustify(column)">
                        <ui-status-badge 
                          [backgroundColorClass]="badgeProperty?.backgroundColorClass ?? null"
                          [indicatorColor]="badgeProperty?.indicatorColorClass ?? null"
                          [borderColorClass]="badgeProperty?.borderColorClass ?? null"
                          [textColorClass]="badgeProperty?.textColorClass ?? null" 
                          [isUpperCase]="true"
                          [status]="badgeProperty?.displayText ?? 'Unknown'">
                        </ui-status-badge>
                      </div>
                    }
                    
                    @case ('custom') {
                      @if (column.component) {
                        <div class="flex items-center">
                          <ui-dynamic-renderer 
                            [component]="column.component" 
                            [rowData]="item" 
                            [data]="column.customConfig?.data"
                            [rowPosition]="$index + 1" 
                            [isLastRow]="$last"
                            (actionPerformed)="onRowActionPerformed($event)">
                          </ui-dynamic-renderer>
                        </div>
                      }
                    }
                    
                    @case ('actions') {
                      <div class="flex items-center justify-center gap-2" [class]="getFlexJustify(column)">
                        <!-- Icon Actions -->
                        @if (column.actionsConfig?.iconActions) {
                          @for (iconAction of column.actionsConfig?.iconActions; track iconAction) {
                            <button
                              type="button"
                              (click)="_onActionClicked(iconAction.actionKey, item, $event)"
                              class="flex items-center justify-center h-8 w-8 cursor-pointer rounded-lg hover:bg-gray-100 active:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                              [title]="iconAction.label || iconAction.actionKey"
                            >
                               <ui-svg-icon [src]="iconAction.iconPath" [size]="16" class="text-gray-600"></ui-svg-icon>
                            </button>
                          }
                        }

                        <!-- Three-dot Menu -->
                        @if (column.actionsConfig?.threeDotMenuActions) {
                          @let menuActions = getContextMenuActions(column.actionsConfig?.threeDotMenuActions, item);
                          @if (menuActions.length > 0) {
                            <ui-context-menu-button
                              (onActionClicked)="_onActionClicked($event, item, null)"
                              [actions]="menuActions"
                              class="relative"
                            >
                              <button 
                                type="button"
                                class="flex items-center justify-center h-8 w-8 cursor-pointer rounded-lg hover:bg-gray-100 active:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                title="More actions"
                              >
                                <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                </svg>
                              </button>
                            </ui-context-menu-button>
                          }
                        }

                        <!-- Custom Components -->
                        @if (column.actionsConfig?.components) {
                          <div class="flex items-center gap-1">
                            @for (component of column.actionsConfig?.components; track $index) {
                              <ui-dynamic-renderer
                                [component]="component"
                                [rowData]="item"
                                [data]="column.customConfig?.data"
                                [rowPosition]="$index + 1"
                                [isLastRow]="$last"
                                (actionPerformed)="onRowActionPerformed($event)"
                              >
                              </ui-dynamic-renderer>
                            }
                          </div>
                        }
                      </div>
                    }
                  }
                </td>
              }
              
            </tr>
          }
        </tbody>
      }

      <!-- Empty State -->
      @if (data().length === 0) {
        <tbody>
          <tr>
            <td [attr.colspan]="allLeafColumns().length + (enableRowSelection() ? 1 : 0)" 
                class="px-6 py-12 text-center text-gray-500 bg-gray-50">
              <div class="flex flex-col items-center space-y-2">
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="text-lg font-medium text-gray-900">No data available</p>
                <p class="text-sm text-gray-500">There are no records to display at this time.</p>
              </div>
            </td>
          </tr>
        </tbody>
      }
    </table>
  </div>

  <!-- Pagination -->
  <div class="border-t-2 border-gray-300 bg-white px-6 py-4 flex-shrink-0">
    <ui-pagination 
      [pageSize]="pageSize()" 
      [totalItems]="totalCount()"
      (pageChange)="onPageChange($event)">
    </ui-pagination>
  </div>
</div>