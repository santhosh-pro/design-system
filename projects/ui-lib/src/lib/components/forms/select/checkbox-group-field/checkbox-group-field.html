<ui-base-input [title]="label()" [width]="width()" [isRequiredField]="hasRequiredField()">
  <div input class="flex flex-row flex-wrap gap-3" [ngClass]="containerClass()">
    @for (item of visibleItems(); track item; let index = $index) {
      <label
        class="flex items-center gap-2 p-2 rounded-md border cursor-pointer transition-all bg-white"
        [ngClass]="{
          'border-primary-500 bg-primary-50': isSelected()(item) && !hasErrors(),
          'border-red-500': hasErrors(),
          'border-gray-300 hover:bg-gray-50': !isSelected()(item) && !hasErrors(),
          'bg-gray-100 cursor-not-allowed': formControl.disabled
        }"
        [attr.aria-selected]="isSelected()(item)"
        [attr.aria-label]="displayText()(item)">
        <input
          type="checkbox"
          [value]="getValueId(item)"
          [checked]="isSelected()(item)"
          [disabled]="formControl.disabled"
          (change)="onItemClicked(item)"
          class="h-4 w-4 text-primary-500 focus:ring-primary-500 disabled:text-gray-400"
        />
        
        @if (icon()(item)) {
          @switch (iconType()(item)) {
            @case ('url') {
              <img
                class="h-5 w-5 object-contain flex-shrink-0"
                [src]="icon()(item)"
                [alt]="displayText()(item) || 'Item icon'"
              />
            }
            @case ('svg') {
              <ui-svg-icon
                [src]="icon()(item)!"
                [size]="18"
                [ngStyle]="{'color': itemIconColor()(item)}"
                class="flex-shrink-0"
              />
            }
          }
        }

        <span
          class="text-sm text-gray-900 whitespace-nowrap"
          [ngClass]="{ 'text-gray-400': formControl.disabled }"
        >
          {{ displayText()(item) }}
        </span>
      </label>
    }

    @if (showMore()) {
      <button
        type="button"
        (click)="showAllItems()"
        class="flex items-center justify-center rounded-md px-3 py-2 text-sm font-medium border border-dashed transition-all"
        [ngClass]="{
          'border-primary-500 text-primary-500 hover:bg-primary-50': !hasErrors() && !formControl.disabled,
          'border-red-500 text-red-500': hasErrors(),
          'border-gray-300 text-gray-400 cursor-not-allowed': formControl.disabled
        }">
        More
      </button>
    }

    @if (showLess()) {
      <button
        type="button"
        (click)="shrinkItems()"
        class="flex items-center justify-center rounded-md px-3 py-2 text-sm font-medium border border-dashed transition-all"
        [ngClass]="{
          'border-primary-500 text-primary-500 hover:bg-primary-50': !hasErrors() && !formControl.disabled,
          'border-red-500 text-red-500': hasErrors(),
          'border-gray-300 text-gray-400 cursor-not-allowed': formControl.disabled
        }">
        Less
      </button>
    }

    @if (customActionText()) {
      <button
        type="button"
        (click)="onCustomActionClick()"
        class="flex items-center justify-center rounded-md px-3 py-2 text-sm font-medium transition-all"
        [ngClass]="{
          'bg-primary-500 text-white hover:bg-primary-600': !formControl.disabled,
          'bg-gray-200 text-gray-400 cursor-not-allowed': formControl.disabled
        }">
        {{ customActionText() }}
      </button>
    }

    @if (state()?.success() && options().length <= 0) {
      <p class="text-sm text-red-700 w-full">{{ emptyMessage() ?? 'No data found' }}</p>
    }
    @if (state()?.failed() && options().length <= 0) {
      <p class="text-sm text-red-700 w-full">{{ state()?.error() ?? emptyMessage() ?? 'No data found' }}</p>
    }
    @if (state()?.loading()) {
      <ui-shimmer class="w-full" type="multiline"></ui-shimmer>
    }
  </div>

  <div error>
    @if (hasErrors()) {
      <p class="text-sm text-red-500 mt-1">
        {{ formControl.errors | humanizeFormMessages: errorMessages() }}
      </p>
    } @else if (showErrorSpace()) {
      <p class="text-sm text-transparent mt-1">.</p>
    }
  </div>
</ui-base-input>